<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panduan Trading Kripto Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts for interactive candlestick simulation -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Chosen Palette: Warm Neutrals -->
    <style>
        body {
            background-color: #FDFDFD;
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 50vh;
        }
        .indicator-chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 150px;
            max-height: 25vh;
        }
        .nav-item.active {
            background-color: #E0E7FF;
            color: #3730A3;
            font-weight: 600;
        }
        .nav-item:hover {
            background-color: #EEF2FF;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .candlestick {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 12px;
            margin: 0 1px;
        }
        .wick {
            width: 2px;
            background-color: currentColor;
        }
        .body {
            width: 100%;
        }
        .green { color: #22C55E; }
        .red { color: #EF4444; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Custom Alert Modal Styles */
        #custom-alert-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        #custom-alert-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        #custom-alert-close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        #custom-alert-close-btn:hover,
        #custom-alert-close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Styles for the new simulation chart and news box */
        #sim-chart-container {
            max-width: 1000px;
            margin: auto;
        }
        #newsBox {
            background: #f1f5f9; /* Light background for news box */
            color: #1e293b; /* Dark text for news box */
            padding: 10px;
            border-radius: 10px;
            max-width: 600px;
            margin: 10px auto;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        #newsBox.breaking {
            background-color: #dc2626; /* Red for breaking news */
            color: white;
            animation: pulse 1s infinite;
            font-weight: bold;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col no-scrollbar overflow-y-auto">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-indigo-700">Trader<span class="font-normal">Muda</span></h1>
                <p class="text-sm text-gray-500 mt-1">Panduan Trading Kripto</p>
            </div>
            <nav class="flex-grow px-4">
                <a href="#dasbor" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg transition-colors duration-200">
                    <span class="mr-3">üè†</span> Dasbor
                </a>
                <a href="#dasar" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg transition-colors duration-200">
                    <span class="mr-3">üß±</span> Dasar Kripto
                </a>
                <a href="#arena" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg transition-colors duration-200">
                    <span class="mr-3">üìà</span> Arena Analisis
                </a>
                <a href="#simulasi" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg transition-colors duration-200">
                    <span class="mr-3">üéÆ</span> Simulasi Trading
                </a>
                <a href="#pustaka" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg transition-colors duration-200">
                    <span class="mr-3">üìö</span> Pustaka Pola
                </a>
                <a href="#perisai" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg transition-colors duration-200">
                    <span class="mr-3">üõ°Ô∏è</span> Perisai Trader
                </a>
            </nav>
            <div class="p-4 mt-auto">
                <div class="bg-indigo-50 p-4 rounded-lg text-center">
                    <p class="text-sm text-indigo-800">Berlatih di <span class="font-bold">KriptoVerse Academy</span> untuk menjadi trader handal tanpa risiko.</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-6 md:p-10 bg-gray-50">
            <!-- Dashboard Section -->
            <section id="dasbor" class="view">
                <h2 class="text-3xl font-bold mb-2">Selamat Datang, Calon Trader!</h2>
                <p class="text-gray-600 mb-8">Ini adalah dasbor Anda untuk menaklukkan dunia trading kripto. Mulailah perjalanan Anda dari nol hingga mahir.</p>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-lg transition-shadow">
                        <h3 class="font-bold text-lg mb-2 flex items-center"><span class="mr-3 text-2xl">üß±</span> Mulai dari Dasar</h3>
                        <p class="text-gray-600 mb-4">Pahami apa itu kripto, blockchain, dan cara kerja order perdagangan.</p>
                        <a href="#dasar" class="nav-direct text-indigo-600 font-semibold hover:underline">Pelajari Sekarang &rarr;</a>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-lg transition-shadow">
                        <h3 class="font-bold text-lg mb-2 flex items-center"><span class="mr-3 text-2xl">üìà</span> Masuk ke Arena</h3>
                        <p class="text-gray-600 mb-4">Analisis grafik harga interaktif dengan berbagai indikator teknis.</p>
                        <a href="#arena" class="nav-direct text-indigo-600 font-semibold hover:underline">Mulai Analisis &rarr;</a>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-lg transition-shadow">
                        <h3 class="font-bold text-lg mb-2 flex items-center"><span class="mr-3 text-2xl">üõ°Ô∏è</span> Lindungi Modal</h3>
                        <p class="text-gray-600 mb-4">Kuasai manajemen risiko dan psikologi trading, kunci kesuksesan Anda.</p>
                        <a href="#perisai" class="nav-direct text-indigo-600 font-semibold hover:underline">Bangun Pertahanan &rarr;</a>
                    </div>
                </div>

                <div class="mt-10 bg-white p-6 rounded-xl shadow-sm">
                     <h3 class="font-bold text-xl mb-4">Tentang Aplikasi Ini</h3>
                     <p class="text-gray-600 leading-relaxed">Aplikasi ini mengubah panduan trading statis menjadi sebuah pengalaman belajar yang dinamis dan interaktif. Tujuannya adalah untuk memberikan Anda, sebagai trader muda, sebuah "tempat latihan" atau "laboratorium" di mana Anda dapat memahami konsep-konsep kompleks dengan cara yang menyenangkan dan praktis. Setiap bagian dirancang untuk membangun pengetahuan Anda secara bertahap, mulai dari fondasi teoretis hingga aplikasi praktis di 'Arena Analisis' dan penguasaan pola pikir di 'Perisai Trader'. Gunakan alat ini untuk bereksperimen, membuat "kesalahan" virtual, dan membangun kepercayaan diri sebelum terjun ke pasar nyata. </p>
                </div>
            </section>

            <!-- Dasar Kripto Section -->
            <section id="dasar" class="view hidden">
                <h2 class="text-3xl font-bold mb-6">Dasar Kripto & Mekanisme Pasar</h2>
                <div class="space-y-4" id="dasar-content"></div>
                <div class="mt-8 pt-6 border-t border-gray-200 bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-xl font-bold mb-4">‚ú® Tanya Ahli AI</h3>
                    <p class="text-gray-600 mb-4">Ajukan pertanyaan tentang konsep dasar kripto atau trading, dan dapatkan penjelasan dari AI.</p>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="ai-question-input" placeholder="Misal: Apa itu 'volume' dalam trading?" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <button id="ask-ai-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors flex-shrink-0">
                            Tanya AI
                        </button>
                    </div>
                    <div id="ai-answer-result" class="mt-4 p-4 bg-indigo-50 rounded-lg text-indigo-800 hidden">
                        <p class="font-semibold mb-2">Jawaban AI:</p>
                        <div id="ai-answer-content" class="text-sm"></div>
                    </div>
                    <div id="ai-answer-loading" class="mt-4 text-center text-indigo-600 hidden">AI sedang berpikir...</div>
                </div>

                <div class="mt-8 pt-6 border-t border-gray-200 bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-xl font-bold mb-4">‚ú® Penjelasan Jargon Kripto</h3>
                    <p class="text-gray-600 mb-4">Bingung dengan istilah kripto? Masukkan jargon di sini dan biarkan AI menjelaskannya.</p>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="jargon-input" placeholder="Misal: Apa itu 'HODL'?" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                        <button id="explain-jargon-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-purple-700 transition-colors flex-shrink-0">
                            Jelaskan Jargon
                        </button>
                    </div>
                    <div id="jargon-result" class="mt-4 p-4 bg-purple-50 rounded-lg text-purple-800 hidden">
                        <p class="font-semibold mb-2">Penjelasan AI:</p>
                        <div id="jargon-content" class="text-sm"></div>
                    </div>
                    <div id="jargon-loading" class="mt-4 text-center text-purple-600 hidden">AI sedang mencari penjelasan...</div>
                </div>
            </section>
            
            <!-- Arena Analisis Section -->
            <section id="arena" class="view hidden">
                 <h2 class="text-3xl font-bold mb-2">Arena Analisis</h2>
                 <p class="text-gray-600 mb-6">Gunakan widget TradingView interaktif di bawah ini untuk menganalisis pergerakan harga secara langsung.</p>

                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <!-- TradingView Widget BEGIN -->
                    <div class="tradingview-widget-container">
                        <div id="tradingview_chart"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                        <script type="text/javascript">
                        new TradingView.widget({
                            "width": "100%", // Make it responsive
                            "height": 500, // Adjust height as needed
                            "symbol": "BINANCE:SOLUSDT", // Default symbol, can be changed dynamically if needed
                            "interval": "1",
                            "timezone": "Etc/UTC",
                            "theme": "light",
                            "style": "1",
                            "locale": "en",
                            "enable_publishing": false,
                            "hide_top_toolbar": false, // Keep toolbar for more features
                            "container_id": "tradingview_chart"
                        });
                        </script>
                    </div>
                    <!-- TradingView Widget END -->

                    <div class="mt-8 pt-6 border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-4">‚ú® Ide Trading dari AI</h3>
                            <p class="text-gray-600 mb-4">Dapatkan contoh ide trading hipotetis berdasarkan koin yang dipilih. Ini hanyalah simulasi untuk belajar, bukan nasihat finansial.</p>
                            <button id="generate-trade-idea-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition-colors flex items-center justify-center w-full">
                                ‚ú® Hasilkan Ide Trading
                            </button>
                            <div id="trade-idea-result" class="mt-4 p-4 bg-indigo-50 rounded-lg text-indigo-800 hidden">
                                <p class="font-semibold mb-2">Ide Trading:</p>
                                <div id="trade-idea-content" class="text-sm"></div>
                            </div>
                            <div id="trade-idea-loading" class="mt-4 text-center text-indigo-600 hidden">Memikirkan ide trading...</div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">‚ú® Analisis Sentimen Pasar AI</h3>
                            <p class="text-gray-600 mb-4">Dapatkan gambaran singkat sentimen pasar (bullish/bearish/netral) untuk koin yang dipilih.</p>
                            <button id="generate-sentiment-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition-colors flex items-center justify-center w-full">
                                ‚ú® Dapatkan Sentimen
                            </button>
                            <div id="sentiment-result" class="mt-4 p-4 bg-green-50 rounded-lg text-green-800 hidden">
                                <p class="font-semibold mb-2">Sentimen AI:</p>
                                <div id="sentiment-content" class="text-sm"></div>
                            </div>
                            <div id="sentiment-loading" class="mt-4 text-center text-green-600 hidden">Menganalisis sentimen...</div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-4">‚ú® Simulasi Skenario Perdagangan</h3>
                            <p class="text-gray-600 mb-4">Masukkan skenario pasar hipotetis dan lihat bagaimana seorang trader mungkin bereaksi.</p>
                            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                                <input type="text" id="scenario-input" placeholder="Misal: Bitcoin tiba-tiba turun 10% karena berita regulasi..." class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2">
                                <button id="simulate-scenario-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-purple-700 transition-colors flex-shrink-0">
                                    Simulasikan
                                </button>
                            </div>
                            <div id="scenario-result" class="mt-4 p-4 bg-purple-50 rounded-lg text-purple-800 hidden">
                                <p class="font-semibold mb-2">Respons AI:</p>
                                <div id="scenario-content" class="text-sm"></div>
                            </div>
                            <div id="scenario-loading" class="mt-4 text-center text-purple-600 hidden">Menjalankan simulasi...</div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">‚ú® Ringkasan Berita Kripto (Hipotetis)</h3>
                            <p class="text-gray-600 mb-4">Dapatkan ringkasan berita hipotetis dan potensi dampaknya pada koin yang dipilih.</p>
                            <button id="generate-news-summary-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center w-full">
                                ‚ú® Hasilkan Berita
                            </button>
                            <div id="news-summary-result" class="mt-4 p-4 bg-blue-50 rounded-lg text-blue-800 hidden">
                                <p class="font-semibold mb-2">Berita AI:</p>
                                <div id="news-summary-content" class="text-sm"></div>
                            </div>
                            <div id="news-summary-loading" class="mt-4 text-center text-blue-600 hidden">Membuat ringkasan berita...</div>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-xl font-bold mb-4">‚ú® Prediksi Tren Jangka Pendek (Hipotetis)</h3>
                        <p class="text-gray-600 mb-4">Dapatkan simulasi prediksi tren jangka pendek untuk koin yang dipilih. Ini hanya untuk tujuan edukasi.</p>
                        <button id="predict-trend-btn" class="bg-orange-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-orange-700 transition-colors flex items-center justify-center w-full">
                            ‚ú® Prediksi Tren
                        </button>
                        <div id="trend-prediction-result" class="mt-4 p-4 bg-orange-50 rounded-lg text-orange-800 hidden">
                            <p class="font-semibold mb-2">Prediksi AI:</p>
                            <div id="trend-prediction-content" class="text-sm"></div>
                        </div>
                        <div id="trend-prediction-loading" class="mt-4 text-center text-orange-600 hidden">AI sedang memprediksi...</div>
                    </div>
                </div>
            </section>

            <!-- Arena Simulasi Trading Section -->
            <section id="simulasi" class="view hidden">
                <h2 class="text-3xl font-bold mb-2">Arena Simulasi Trading</h2>
                <p class="text-gray-600 mb-6">Berlatih trading dengan modal virtual dan rasakan dinamika pasar, termasuk reaksi terhadap berita mendadak!</p>

                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div id="sim-controls" class="flex flex-col sm:flex-row gap-4 mb-6 items-center justify-between">
                        <div class="flex items-center gap-4">
                            <label for="sim-coin-select" class="block text-sm font-medium text-gray-700">Pilih Koin:</label>
                            <select id="sim-coin-select" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div class="flex gap-2">
                            <!-- Overall Start/Reset buttons -->
                            <button id="sim-start-sim-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                                Mulai Simulasi
                            </button>
                            <button id="sim-reset-sim-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors hidden">
                                Reset Simulasi
                            </button>
                        </div>
                    </div>

                    <div id="sim-info" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-600">Saldo USDT Anda:</p>
                            <p id="sim-balance" class="text-xl font-bold text-gray-800">$10,000.00</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-600">Harga Saat Ini (<span id="sim-current-coin-display">BTC</span>):</p>
                            <p id="sim-current-price" class="text-xl font-bold text-gray-800">$0.00</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-600">Koin Anda (<span id="sim-holding-coin-display">BTC</span>):</p>
                            <p id="sim-coin-holding" class="text-xl font-bold text-gray-800">0.00</p>
                        </div>
                    </div>

                    <div id="sim-pnl-info" class="bg-gray-100 p-4 rounded-lg text-center mb-6 hidden">
                        <p class="text-sm text-gray-600">Keuntungan/Kerugian Mengambang:</p>
                        <p id="sim-pnl" class="text-xl font-bold text-gray-800">$0.00</p>
                    </div>

                    <!-- Candlestick Example for Simulation Trading -->
                    <div class="flex justify-center items-center h-12 mb-4">
                        <span class="text-sm text-gray-600 mr-2">Contoh Candlestick:</span>
                        <div id="sim-candlestick-examples" class="flex items-end h-12"></div>
                    </div>

                    <!-- ApexCharts Simulation Chart & Controls -->
                    <div id="sim-chart-container" class="w-full border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex flex-col sm:flex-row gap-4 mb-4 items-center justify-center p-4">
                            <label for="sim-timeframe" class="block text-sm font-medium text-gray-700">Timeframe:</label>
                            <select id="sim-timeframe" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="1000">1 Detik</option>
                                <option value="3000">3 Detik</option>
                                <option value="5000">5 Detik</option>
                                <option value="10000">10 Detik</option>
                                <option value="60000">1 Menit</option>
                                <option value="300000">5 Menit</option>
                                <option value="900000">15 Menit</option>
                                <option value="1800000">30 Menit</option>
                                <option value="3600000">1 Jam</option>
                                <option value="86400000">1 Hari</option>
                            </select>
                            <button id="sim-chart-pauseBtn" class="bg-amber-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-amber-700 transition-colors">‚è∏Ô∏è Pause</button>
                            <button id="sim-chart-resumeBtn" class="bg-emerald-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-emerald-700 transition-colors">‚ñ∂Ô∏è Resume</button>
                        </div>
                        <div id="chart" style="height: 350px;"></div>
                        <div id="volumeChart" style="height: 150px;"></div>
                        <div id="chart-info" class="text-center mt-2 mb-4">
                            <span id="price" class="font-semibold text-lg">Harga: $0.00</span>
                            <span id="change" class="ml-4 font-semibold text-lg">Change: 0%</span>
                            <span id="direction" class="ml-2 text-xl">‚¨ç</span>
                        </div>
                    </div>

                    <div id="sim-trade-actions" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-lg mb-3 text-green-800">Beli Koin</h4>
                            <div class="flex flex-col gap-3">
                                <input type="number" id="buy-amount" placeholder="Jumlah USDT untuk dibeli" class="rounded-md border-green-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2">
                                <button id="buy-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    Beli <span id="buy-coin-display">BTC</span>
                                </button>
                            </div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-lg mb-3 text-red-800">Jual Koin</h4>
                            <div class="flex flex-col gap-3">
                                <input type="number" id="sell-amount" placeholder="Jumlah koin untuk dijual" class="rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2">
                                <button id="sell-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors">
                                    Jual <span id="sell-coin-display">BTC</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- New AI-powered features for Simulation -->
                    <div class="mt-8 pt-6 border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-4">‚ú® Analisis Perdagangan AI</h3>
                            <p class="text-gray-600 mb-4">Dapatkan analisis AI singkat tentang transaksi terakhir Anda.</p>
                            <button id="analyze-trade-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition-colors flex items-center justify-center w-full">
                                ‚ú® Analisis Perdagangan
                            </button>
                            <div id="trade-analysis-result" class="mt-4 p-4 bg-indigo-50 rounded-lg text-indigo-800 hidden">
                                <p class="font-semibold mb-2">Analisis AI:</p>
                                <div id="trade-analysis-content" class="text-sm"></div>
                            </div>
                            <div id="trade-analysis-loading" class="mt-4 text-center text-indigo-600 hidden">AI sedang menganalisis...</div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">‚ú® Saran Strategi AI</h3>
                            <p class="text-gray-600 mb-4">Dapatkan saran strategi trading umum berdasarkan kondisi pasar simulasi saat ini.</p>
                            <button id="suggest-strategy-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition-colors flex items-center justify-center w-full">
                                ‚ú® Saran Strategi
                            </button>
                            <div id="strategy-suggestion-result" class="mt-4 p-4 bg-green-50 rounded-lg text-green-800 hidden">
                                <p class="font-semibold mb-2">Saran AI:</p>
                                <div id="strategy-suggestion-content" class="text-sm"></div>
                            </div>
                            <div id="strategy-suggestion-loading" class="mt-4 text-center text-green-600 hidden">AI sedang menyarankan...</div>
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-xl font-bold mb-4">‚ú® Evaluasi Portofolio AI</h3>
                        <p class="text-gray-600 mb-4">Dapatkan evaluasi kinerja portofolio Anda dari AI.</p>
                        <button id="evaluate-portfolio-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-purple-700 transition-colors flex items-center justify-center w-full">
                            ‚ú® Evaluasi Portofolio
                        </button>
                        <div id="portfolio-evaluation-result" class="mt-4 p-4 bg-purple-50 rounded-lg text-purple-800 hidden">
                            <p class="font-semibold mb-2">Evaluasi AI:</p>
                            <div id="portfolio-evaluation-content" class="text-sm"></div>
                        </div>
                        <div id="portfolio-evaluation-loading" class="mt-4 text-center text-purple-600 hidden">AI sedang mengevaluasi...</div>
                    </div>

                    <div id="news" class="mt-6">
                        <h3 class="text-xl font-bold mb-2">üì∞ Berita Pasar</h3>
                        <div id="newsBox" class="p-4 text-center">Tidak ada berita saat ini...</div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Log Transaksi</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Waktu</th>
                                        <th scope="col" class="px-6 py-3">Koin</th>
                                        <th scope="col" class="px-6 py-3">Aksi</th>
                                        <th scope="col" class="px-6 py-3">Jumlah</th>
                                        <th scope="col" class="px-6 py-3">Harga</th>
                                        <th scope="col" class="px-6 py-3">Total USDT</th>
                                        <th scope="col" class="px-6 py-3">P/L (%)</th>
                                        <th scope="col" class="px-6 py-3">P/L ($)</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-log-body">
                                    <!-- Transaction rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pustaka Pola Section -->
            <section id="pustaka" class="view hidden">
                <h2 class="text-3xl font-bold mb-6">Pustaka Pola</h2>
                <div class="mb-8">
                     <h3 class="text-2xl font-semibold mb-2">Pola Candlestick</h3>
                     <p class="text-gray-600 mb-4">Kenali sinyal pasar melalui formasi lilin individu. Klik setiap kartu untuk detail.</p>
                     <div id="candlestick-patterns-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>
                <div>
                     <h3 class="text-2xl font-semibold mb-2">Pola Grafik</h3>
                      <p class="text-gray-600 mb-4">Identifikasi formasi harga yang lebih besar yang menandakan pembalikan atau kelanjutan tren.</p>
                     <div id="chart-patterns-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </section>

            <!-- Removed "Strategi Koin" section as requested -->

            <!-- Perisai Trader Section -->
            <section id="perisai" class="view hidden">
                 <h2 class="text-3xl font-bold mb-6">Perisai Trader: Risiko & Psikologi</h2>
                 <p class="text-gray-600 mb-8">Bab ini adalah fondasi kesuksesan jangka panjang. Kuasai ini, dan Anda akan selangkah lebih maju dari yang lain.</p>
                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold mb-4">Kalkulator Manajemen Risiko</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Ukuran Posisi (Aturan 1%)</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="pos-size-account" class="text-sm">Ukuran Akun ($)</label>
                                        <input type="number" id="pos-size-account" value="10000" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="pos-size-risk" class="text-sm">Risiko (%)</label>
                                        <input type="number" id="pos-size-risk" value="1" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="pos-size-entry" class="text-sm">Harga Masuk</label>
                                        <input type="number" id="pos-size-entry" placeholder="cth: 50000" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="pos-size-sl" class="text-sm">Harga Stop-Loss</label>
                                        <input type="number" id="pos-size-sl" placeholder="cth: 49500" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                </div>
                                <div id="pos-size-result" class="mt-4 text-center bg-indigo-50 p-3 rounded-lg font-semibold text-indigo-800">Masukkan harga untuk menghitung.</div>
                            </div>
                            <hr/>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Rasio Risiko-Imbalan</h4>
                                <div class="grid grid-cols-1 gap-4">
                                     <div>
                                        <label for="rr-entry" class="text-sm">Harga Masuk</label>
                                        <input type="number" id="rr-entry" placeholder="cth: 50000" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label for="rr-tp" class="text-sm">Harga Take-Profit</label>
                                        <input type="number" id="rr-tp" placeholder="cth: 51000" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                     <div>
                                        <label for="rr-sl" class="text-sm">Harga Stop-Loss</label>
                                        <input type="number" id="rr-sl" placeholder="cth: 49500" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                </div>
                                <div id="rr-result" class="mt-4 text-center bg-green-50 p-3 rounded-lg font-semibold text-green-800">Masukkan harga untuk menghitung.</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold mb-4">Menguasai Pikiran Anda</h3>
                        <div id="psychology-content"></div>
                    </div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-xl font-bold mb-4">Jurnal Perdagangan: Peta Jalan Anda</h3>
                    <p class="text-gray-600 mb-4">Jurnal adalah alat paling ampuh untuk peningkatan. Gunakan struktur ini untuk melacak dan belajar dari setiap perdagangan (bahkan yang simulasi).</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Item</th>
                                    <th scope="col" class="px-6 py-3">Contoh Catatan</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white border-b"><td class="px-6 py-4 font-semibold" colspan="2">Pra-Perdagangan</td></tr>
                                <tr class="bg-white border-b"><td class="px-6 py-4">Alasan Masuk</td><td class="px-6 py-4">BTC/USDT: Breakout dari pola segitiga naik di grafik 4jam, dikonfirmasi volume.</td></tr>
                                <tr class="bg-white border-b"><td class="px-6 py-4">Stop-Loss</td><td class="px-6 py-4">Ditetapkan di $68,500, sedikit di bawah support garis tren bawah.</td></tr>
                                <tr class="bg-white border-b"><td class="px-6 py-4 font-semibold" colspan="2">Pasca-Perdagangan</td></tr>
                                <tr class="bg-white border-b"><td class="px-6 py-4">Hasil</td><td class="px-6 py-4">Keluar di TP $71,000. Keuntungan +2.5%.</td></tr>
                                <tr class="bg-white border-b"><td class="px-6 py-4">Pelajaran</td><td class="px-6 py-4">Strategi breakout berhasil. Kesabaran menunggu konfirmasi volume terbayar.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Pattern Insight Modal -->
    <div id="pattern-insight-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-pattern-name" class="text-2xl font-bold mb-4"></h3>
            <p id="modal-pattern-desc" class="text-gray-700 mb-4"></p>
            <div id="modal-pattern-illustration" class="flex justify-center mb-4"></div>
            <button id="generate-pattern-insight-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 transition-colors">
                ‚ú® Dapatkan Insight Pola
            </button>
            <div id="pattern-insight-result" class="mt-4 p-4 bg-purple-50 rounded-lg text-purple-800 hidden">
                <p class="font-semibold mb-2">Insight AI:</p>
                <div id="pattern-insight-content" class="text-sm"></div>
            </div>
            <div id="pattern-insight-loading" class="mt-4 text-center text-purple-600 hidden">Menganalisis pola...</div>
        </div>
    </div>

    <!-- Custom Alert Modal HTML -->
    <div id="custom-alert-modal">
        <div id="custom-alert-content">
            <span id="custom-alert-close-btn">&times;</span>
            <p id="custom-alert-message" class="text-gray-700 font-semibold mb-4"></p>
            <button id="custom-alert-ok-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">OK</button>
        </div>
    </div>

<script>
window.onload = () => {

    // Custom Alert Function
    function showAlert(message) {
        const modal = document.getElementById('custom-alert-modal');
        const messageElement = document.getElementById('custom-alert-message');
        const closeButton = document.getElementById('custom-alert-close-btn');
        const okButton = document.getElementById('custom-alert-ok-btn');

        messageElement.textContent = message;
        modal.style.display = 'flex';

        const closeAlert = () => {
            modal.style.display = 'none';
            closeButton.removeEventListener('click', closeAlert);
            okButton.removeEventListener('click', closeAlert);
            modal.removeEventListener('click', handleModalClick);
        };

        const handleModalClick = (event) => {
            if (event.target === modal) {
                closeAlert();
            }
        };

        closeButton.addEventListener('click', closeAlert);
        okButton.addEventListener('click', closeAlert);
        modal.addEventListener('click', handleModalClick);
    }

    // --- DATA STORE ---
    const appData = {
        dasar: [
            {
                title: "Apa Itu Mata Uang Kripto?",
                content: "Mata uang kripto adalah mata uang digital yang menggunakan enkripsi untuk keamanan. Tidak seperti mata uang tradisional, kripto bersifat terdesentralisasi, artinya tidak dikendalikan oleh bank atau pemerintah. Nilainya berasal dari teknologi, kelangkaan, dan kepercayaan komunitas."
            },
            {
                title: "Kekuatan Teknologi Blockchain",
                content: "Blockchain adalah buku besar digital yang terdistribusi dan tidak dapat diubah (immutable). Setiap transaksi dicatat dalam 'blok' dan dihubungkan bersama membentuk 'rantai'. Teknologi ini adalah tulang punggung yang membuat kripto aman dan transparan tanpa memerlukan pihak ketiga."
            },
            {
                title: "Jenis-Jenis Order Perdagangan",
                content: `
                    <ul class="space-y-3 list-disc list-inside">
                        <li><span class="font-semibold">Market Order:</span> Beli/jual instan pada harga pasar terbaik yang tersedia. Prioritasnya kecepatan, bukan harga.</li>
                        <li><span class="font-semibold">Limit Order:</span> Beli/jual pada harga yang Anda tentukan atau lebih baik. Memberi Anda kontrol harga, tetapi eksekusi tidak dijamin.</li>
                        <li><span class="font-semibold">Stop-Loss Order:</span> Jaring pengaman Anda. Menjual aset secara otomatis jika harga turun ke level tertentu untuk membatasi kerugian.</li>
                        <li><span class="font-semibold">Take-Profit Order:</span> Mengunci keuntungan. Menjual aset secara otomatis jika harga naik ke target keuntungan Anda.</li>
                    </ul>
                `
            }
        ],
        coins: {
            USDT: { name: 'Tether', type: 'Stablecoin' },
            BTC: { name: 'Bitcoin', type: 'Aset Inti', initialPrice: 60000 },
            ETH: { name: 'Ethereum', type: 'Aset Inti/Platform', initialPrice: 3000 },
            SOL: { name: 'Solana', type: 'Aset Inti/L1', initialPrice: 150 },
            BNB: { name: 'BNB', type: 'Utilitas/Bursa', initialPrice: 500 },
            ADA: { name: 'Cardano', type: 'Aset Inti/L1', initialPrice: 0.5 },
        },
        indicators: {
            ma50: { name: 'MA 50', type: 'overlay', color: 'rgba(255, 159, 64, 1)' },
            ma200: { name: 'MA 200', type: 'overlay', color: 'rgba(54, 162, 235, 1)' },
            bb: { name: 'Bollinger Bands', type: 'overlay', color: 'rgba(75, 192, 192, 0.2)' },
            rsi: { name: 'RSI', type: 'indicator_chart', color: 'rgba(153, 102, 255, 1)'},
            macd: { name: 'MACD', type: 'indicator_chart', color: 'rgba(255, 99, 132, 1)'}
        },
        candlestickPatterns: [
            { name: "Doji", signal: "Keraguan", desc: "Badan sangat kecil atau tidak ada, menandakan keraguan pasar dan potensi titik balik.", illustration: { type: 'doji' } },
            { name: "Hammer", signal: "Pembalikan Bullish", desc: "Terjadi setelah tren turun. Sumbu bawah panjang menunjukkan pembeli menolak harga yang lebih rendah.", illustration: { type: 'hammer' } },
            { name: "Bullish Engulfing", signal: "Pembalikan Bullish Kuat", desc: "Lilin hijau besar 'menelan' lilin merah sebelumnya, menandakan pergeseran kuat ke sentimen beli.", illustration: { type: 'bullish_engulfing' } },
            { name: "Bearish Engulfing", signal: "Pembalikan Bearish Kuat", desc: "Lilin merah besar 'menelan' lilin hijau sebelumnya, menandakan tekanan jual yang dominan.", illustration: { type: 'bearish_engulfing' } },
            { name: "Hanging Man", signal: "Pembalikan Bearish", desc: "Mirip Hammer tapi setelah tren naik. Menunjukkan penjual mulai masuk ke pasar.", illustration: { type: 'hanging_man' } },
            { name: "Shooting Star", signal: "Pembalikan Bearish", desc: "Badan kecil di bawah dengan sumbu atas panjang. Pembeli mencoba mendorong harga naik tetapi gagal.", illustration: { type: 'shooting_star' } },
        ],
        chartPatterns: [
            { name: "Head and Shoulders", type: "Pembalikan Bearish", desc: "Pola tiga puncak (puncak tengah tertinggi) yang menandakan akhir dari tren naik. Dikonfirmasi jika harga menembus 'garis leher' ke bawah." },
            { name: "Inverse Head and Shoulders", type: "Pembalikan Bullish", desc: "Kebalikan dari H&S, terbentuk setelah tren turun dan menandakan potensi pembalikan ke atas." },
            { name: "Double Top", type: "Pembalikan Bearish", desc: "Bentuk 'M' di mana harga gagal menembus level resistance dua kali. Menunjukkan kelelahan pembeli." },
            { name: "Double Bottom", type: "Pembalikan Bullish", desc: "Bentuk 'W' di mana harga memantul dari level support dua kali. Menunjukkan kekuatan pembeli." },
            { name: "Ascending Triangle", type: "Kelanjutan Bullish", desc: "Terbentuk dengan resistance datar dan support yang menanjak. Menunjukkan akumulasi oleh pembeli." },
            { name: "Descending Triangle", type: "Kelanjutan Bearish", desc: "Terbentuk dengan support datar dan resistance yang menurun. Menunjukkan tekanan jual yang meningkat." },
        ],
        psychology: [
            {
                name: "FOMO (Fear Of Missing Out)",
                emoji: "üò±",
                desc: "Dorongan untuk membeli aset yang harganya sedang meroket karena takut ketinggalan keuntungan. Seringkali berakhir dengan membeli di puncak.",
                solution: "Tetap pada rencana trading Anda. Jangan pernah masuk ke perdagangan tanpa analisis. Jika Anda terlambat, biarkan saja, akan selalu ada peluang lain."
            },
            {
                name: "Keserakahan",
                emoji: "ü§ë",
                desc: "Keinginan untuk keuntungan berlebihan, membuat Anda menahan posisi terlalu lama atau mengambil risiko yang tidak perlu.",
                solution: "Selalu tetapkan target take-profit sebelum masuk. Saat target tercapai, jangan ragu untuk mengambil keuntungan. Disiplin lebih penting dari keuntungan ekstra."
            },
            {
                name: "Panik",
                emoji: "üò∞",
                desc: "Menjual aset secara membabi bluta saat pasar turun karena ketakutan ekstrem akan kerugian yang lebih besar.",
                solution: "Gunakan stop-loss. Stop-loss adalah keputusan logis yang Anda buat saat pikiran jernih. Percayalah pada analisis Anda, bukan emosi sesaat."
            }
        ],
    };

    // --- STATE MANAGEMENT ---
    let state = {
        activeView: 'dasbor',
        activeCoin: 'BTC', // Default to BTC
        activeIndicators: {
            ma50: false,
            ma200: false,
            bb: false,
            rsi: false,
            macd: false,
        },
        // Simulation state
        simulation: {
            active: false,
            balance: 10000, // Starting USDT balance
            coinHoldings: {}, // e.g., { BTC: 0.5 }
            currentPrice: 0,
            selectedSimCoin: 'BTC',
            candleData: [], // Stores OHLC objects for ApexCharts {x: timestamp, y: [O, H, L, C]}
            volumeData: [], // Stores volume data for ApexCharts {x: timestamp, y: V}
            simChartInstance: null, // ApexCharts main instance
            simVolumeChartInstance: null, // ApexCharts volume instance
            simLastTime: Date.now(), // For ApexCharts time (milliseconds)
            simTimeframeMilliseconds: 60000, // Default 1 minute (1 candle = 1 minute) in milliseconds
            priceInterval: null,
            newsInterval: null,
            newsImpact: 0,
            newsIndex: 0,
            breakingTimeout: null,
            initialBuyPrice: 0, // To track PnL
            transactions: [], // New: Array to store transaction logs
            newsList: [
                { text: "üöÄ Binance umumkan token baru, volume naik tajam!", impact: 2 },
                { text: "‚ö†Ô∏è SEC investigasi proyek crypto besar! Pasar panik!", impact: -3 },
                { text: "üìâ Bitcoin anjlok 7% dalam 1 jam setelah tweet Elon Musk", impact: -2 },
                { text: "üì¢ Ethereum 2.0 resmi dirilis, sentimen positif kuat!", impact: 1.5 },
                { text: "üíº Investor institusi masuk ke Solana, harga melonjak.", impact: 2 }
            ]
        }
    };
    
    // --- RENDERING FUNCTIONS ---
    function render() {
        // Update view visibility
        document.querySelectorAll('.view').forEach(view => {
            view.classList.toggle('hidden', view.id !== state.activeView);
        });

        // Update nav active class
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.toggle('active', nav.hash === `#${state.activeView}`);
        });

        if (state.activeView === 'simulasi') {
            updateSimulationUI();
            // If navigating to simulation and chart is not initialized, initialize it
            if (!state.simulation.simChartInstance) {
                initializeSimChart();
            }
        } else {
            // Stop simulation intervals if leaving the simulation view
            stopSimulationChart();
            stopNewsGeneration(); // Stop news generation when leaving simulation
        }
    }

    function init() {
        // Initial setup functions
        setupNavigation();
        populateDasarContent();
        populatePatternLibraries();
        populatePsychologyContent();
        setupRiskCalculators();
        setupGeminiFeatures(); // New function for Gemini features
        setupSimulation(); // New function for simulation
        insertCandlestickExamples(); // Call this after DOM is loaded and function is defined

        // Set initial view
        const initialView = window.location.hash ? window.location.hash.substring(1) : 'dasbor';
        state.activeView = initialView;
        render();
    }
    
    function setupNavigation() {
        document.querySelectorAll('.nav-item, .nav-direct').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = e.currentTarget.hash.substring(1);
                state.activeView = viewId;
                window.location.hash = viewId;
                render();
            });
        });
        window.addEventListener('hashchange', () => {
            const viewId = window.location.hash ? window.location.hash.substring(1) : 'dasbor';
            state.activeView = viewId;
            render();
        });
    }

    function populateDasarContent() {
        const container = document.getElementById('dasar-content');
        container.innerHTML = appData.dasar.map(item => `
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-xl font-bold mb-3">${item.title}</h3>
                <p class="text-gray-700 leading-relaxed">${item.content}</p>
            </div>
        `).join('');
    }
    
    function populatePatternLibraries() {
        const candlestickContainer = document.getElementById('candlestick-patterns-container');
        candlestickContainer.innerHTML = appData.candlestickPatterns.map((p, index) => `
            <div class="bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow pattern-card" data-pattern-type="candlestick" data-pattern-index="${index}">
                <div class="flex justify-between items-start">
                    <div>
                         <h4 class="font-bold">${p.name}</h4>
                         <p class="text-sm font-semibold ${p.signal.includes('Bullish') ? 'text-green-600' : 'text-red-600'}">${p.signal}</p>
                    </div>
                    <div class="candlestick-illustration">${generateCandlestickIllustration(p.illustration)}</div>
                </div>
                <p class="text-sm text-gray-600 mt-2">${p.desc}</p>
            </div>
        `).join('');

        const chartPatternContainer = document.getElementById('chart-patterns-container');
        chartPatternContainer.innerHTML = appData.chartPatterns.map((p, index) => `
            <div class="bg-white p-6 rounded-xl shadow-sm cursor-pointer hover:shadow-md transition-shadow pattern-card" data-pattern-type="chart" data-pattern-index="${index}">
                <h4 class="font-bold text-lg mb-1">${p.name}</h4>
                <p class="text-sm font-semibold mb-2 ${p.type.includes('Bullish') ? 'text-green-600' : 'text-red-600'}">${p.type}</p>
                <p class="text-sm text-gray-600">${p.desc}</p>
            </div>
        `).join('');

        document.querySelectorAll('.pattern-card').forEach(card => {
            card.addEventListener('click', (e) => {
                const type = e.currentTarget.dataset.patternType;
                const index = parseInt(e.currentTarget.dataset.patternIndex);
                const pattern = type === 'candlestick' ? appData.candlestickPatterns[index] : appData.chartPatterns[index];
                showPatternInsightModal(pattern, type);
            });
        });
    }

    function generateCandlestickIllustration(illustration) {
        let candles = [];
        const baseClass = "candlestick";
        switch (illustration.type) {
            case 'doji':
                candles.push(`<div class="${baseClass} green"><div class="wick" style="height: 15px;"></div><div class="body" style="height: 2px;"></div><div class="wick" style="height: 15px;"></div></div>`);
                break;
            case 'hammer':
                candles.push(`<div class="${baseClass} green"><div class="wick" style="height: 2px;"></div><div class="body" style="height: 8px;"></div><div class="wick" style="height: 25px;"></div></div>`);
                break;
            case 'bullish_engulfing':
                candles.push(`<div class="${baseClass} red" style="transform: scale(0.8);"><div class="wick" style="height: 5px;"></div><div class="body" style="height: 15px;"></div><div class="wick" style="height: 5px;"></div></div>`);
                candles.push(`<div class="${baseClass} green"><div class="wick" style="height: 2px;"></div><div class="body" style="height: 30px;"></div><div class="wick" style="height: 2px;"></div></div>`);
                break;
            case 'bearish_engulfing':
                candles.push(`<div class="${baseClass} green" style="transform: scale(0.8);"><div class="wick" style="height: 5px;"></div><div class="body" style="height: 15px;"></div><div class="wick" style="height: 5px;"></div></div>`);
                candles.push(`<div class="${baseClass} red"><div class="wick" style="height: 2px;"></div><div class="body" style="height: 30px;"></div><div class="wick" style="height: 2px;"></div></div>`);
                break;
            case 'hanging_man':
                candles.push(`<div class="${baseClass} red"><div class="wick" style="height: 2px;"></div><div class="body" style="height: 8px;"></div><div class="wick" style="height: 25px;"></div></div>`);
                break;
            case 'shooting_star':
                 candles.push(`<div class="${baseClass} red"><div class="wick" style="height: 25px;"></div><div class="body" style="height: 8px;"></div><div class="wick" style="height: 2px;"></div></div>`);
                break;
            case 'bullish_example': // New example for general bullish candle
                candles.push(`<div class="${baseClass} green"><div class="wick" style="height: 5px;"></div><div class="body" style="height: 20px;"></div><div class="wick" style="height: 5px;"></div></div>`);
                break;
            case 'bearish_example': // New example for general bearish candle
                candles.push(`<div class="${baseClass} red"><div class="wick" style="height: 5px;"></div><div class="body" style="height: 20px;"></div><div class="wick" style="height: 5px;"></div></div>`);
                break;
        }
        return `<div class="flex items-end h-12">${candles.join('')}</div>`;
    }

    // Function to insert candlestick examples into their respective containers
    function insertCandlestickExamples() {
        const simExamplesContainer = document.getElementById('sim-candlestick-examples');
        if (simExamplesContainer) {
            simExamplesContainer.innerHTML = 
                generateCandlestickIllustration({type: 'bullish_example'}) +
                generateCandlestickIllustration({type: 'bearish_example'});
        }
    }

    function populatePsychologyContent() {
        const container = document.getElementById('psychology-content');
        container.innerHTML = appData.psychology.map(p => `
            <div class="mb-5">
                <h4 class="font-semibold text-lg mb-2 flex items-center">${p.emoji} <span class="ml-2">${p.name}</span></h4>
                <p class="text-gray-600 text-sm mb-2">${p.desc}</p>
                <div class="bg-indigo-50 text-indigo-800 p-3 rounded-lg text-sm">
                    <strong class="font-semibold">Solusi:</strong> ${p.solution}
                </div>
            </div>
        `).join('');
    }

    function setupRiskCalculators() {
        const inputsPosSize = ['pos-size-account', 'pos-size-risk', 'pos-size-entry', 'pos-size-sl'];
        const inputsRR = ['rr-entry', 'rr-tp', 'rr-sl'];
        
        inputsPosSize.forEach(id => document.getElementById(id).addEventListener('input', calculatePositionSize));
        inputsRR.forEach(id => document.getElementById(id).addEventListener('input', calculateRiskReward));
    }

    function calculatePositionSize() {
        const accountSize = parseFloat(document.getElementById('pos-size-account').value);
        const riskPercent = parseFloat(document.getElementById('pos-size-risk').value);
        const entryPrice = parseFloat(document.getElementById('pos-size-entry').value);
        const slPrice = parseFloat(document.getElementById('pos-size-sl').value);
        const resultEl = document.getElementById('pos-size-result');

        if (isNaN(accountSize) || isNaN(riskPercent) || isNaN(entryPrice) || isNaN(slPrice) || entryPrice <= slPrice) {
            showAlert("Masukkan semua nilai yang valid untuk Ukuran Posisi."); 
            resultEl.innerHTML = "Masukkan semua nilai yang valid.";
            resultEl.className = "mt-4 text-center bg-red-50 p-3 rounded-lg font-semibold text-red-800";
            return;
        }

        const riskAmount = accountSize * (riskPercent / 100);
        const riskPerShare = entryPrice - slPrice;
        const positionSize = riskAmount / riskPerShare;

        resultEl.innerHTML = `Beli ${positionSize.toFixed(4)} unit (${(positionSize * entryPrice).toLocaleString('id-ID', {style:'currency', currency:'USD', minimumFractionDigits: 2})})`;
        resultEl.className = "mt-4 text-center bg-indigo-50 p-3 rounded-lg font-semibold text-indigo-800";
    }

    function calculateRiskReward() {
        const entryPrice = parseFloat(document.getElementById('rr-entry').value);
        const tpPrice = parseFloat(document.getElementById('rr-tp').value);
        const slPrice = parseFloat(document.getElementById('rr-sl').value);
        const resultEl = document.getElementById('rr-result');

        if (isNaN(entryPrice) || isNaN(tpPrice) || isNaN(slPrice) || entryPrice <= slPrice || entryPrice >= tpPrice) {
             showAlert("Masukkan semua nilai yang valid untuk Rasio Risiko-Imbalan."); 
             resultEl.innerHTML = "Masukkan semua nilai yang valid.";
             resultEl.className = "mt-4 text-center bg-red-50 p-3 rounded-lg font-semibold text-red-800";
            return;
        }

        const potentialReward = tpPrice - entryPrice;
        const potentialRisk = entryPrice - slPrice;
        const ratio = potentialReward / potentialRisk;

        let className = "mt-4 text-center p-3 rounded-lg font-semibold ";
        if(ratio >= 2) {
            className += "bg-green-50 text-green-800";
        } else if (ratio >= 1) {
            className += "bg-yellow-50 text-yellow-800";
        } else {
             className += "bg-red-50 text-red-800";
        }
        resultEl.className = className;
        resultEl.innerHTML = `Rasio 1 : ${ratio.toFixed(2)} ${ratio >= 2 ? 'üëç' : (ratio >= 1 ? 'ü§î' : 'üëé')}`;
    }

    // --- GEMINI API INTEGRATION ---
    async function callGeminiAPI(prompt) {
        const apiKey = "AIzaSyAq0Yfk9DucUsEB1QqMxOsJE9UfJPkafSc"; // IMPORTANT: For a public website, you should secure this API key on a server-side or serverless function.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });

        const payload = { contents: chatHistory };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error("Unexpected API response structure:", result);
                return "Maaf, saya tidak dapat menghasilkan insight saat ini. Coba lagi nanti.";
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            return "Terjadi kesalahan saat menghubungi AI. Periksa koneksi internet Anda.";
        }
    }

    function setupGeminiFeatures() {
        // Trade Idea Generator
        const generateTradeIdeaBtn = document.getElementById('generate-trade-idea-btn');
        const tradeIdeaResultDiv = document.getElementById('trade-idea-result');
        const tradeIdeaContentDiv = document.getElementById('trade-idea-content');
        const tradeIdeaLoadingDiv = document.getElementById('trade-idea-loading');

        generateTradeIdeaBtn.addEventListener('click', async () => {
            tradeIdeaResultDiv.classList.add('hidden');
            tradeIdeaLoadingDiv.classList.remove('hidden');
            tradeIdeaContentDiv.innerHTML = '';

            const coinName = "koin kripto yang sedang Anda analisis";
            const prompt = `Berikan ide trading hipotetis (entry, stop-loss, take-profit, dan alasan singkat) untuk ${coinName} di pasar kripto. Anggap pasar sedang dalam tren acak. Format respons sebagai poin-poin.`;

            const idea = await callGeminiAPI(prompt);
            tradeIdeaContentDiv.innerHTML = idea;
            tradeIdeaLoadingDiv.classList.add('hidden');
            tradeIdeaResultDiv.classList.remove('hidden');
        });

        // Market Sentiment Generator
        const generateSentimentBtn = document.getElementById('generate-sentiment-btn');
        const sentimentResultDiv = document.getElementById('sentiment-result');
        const sentimentContentDiv = document.getElementById('sentiment-content');
        const sentimentLoadingDiv = document.getElementById('sentiment-loading');

        generateSentimentBtn.addEventListener('click', async () => {
            sentimentResultDiv.classList.add('hidden');
            sentimentLoadingDiv.classList.remove('hidden');
            sentimentContentDiv.innerHTML = '';

            const coinName = "koin kripto yang sedang Anda analisis";
            const prompt = `Berikan analisis sentimen pasar (bullish, bearish, atau netral) singkat untuk ${coinName} di pasar kripto saat ini, beserta alasan singkatnya. Anggap Anda adalah analis pasar yang menyederhanakan informasi untuk pemula.`;

            const sentiment = await callGeminiAPI(prompt);
            sentimentContentDiv.innerHTML = sentiment;
            sentimentLoadingDiv.classList.add('hidden');
            sentimentResultDiv.classList.remove('hidden');
        });

        // Ask AI Expert
        const askAiBtn = document.getElementById('ask-ai-btn');
        const aiQuestionInput = document.getElementById('ai-question-input');
        const aiAnswerResultDiv = document.getElementById('ai-answer-result');
        const aiAnswerContentDiv = document.getElementById('ai-answer-content');
        const aiAnswerLoadingDiv = document.getElementById('ai-answer-loading');

        askAiBtn.addEventListener('click', async () => {
            const question = aiQuestionInput.value.trim();
            if (!question) {
                aiAnswerResultDiv.classList.remove('hidden');
                aiAnswerResultDiv.className = "mt-4 p-4 bg-red-50 rounded-lg text-red-800";
                aiAnswerContentDiv.innerHTML = "Mohon masukkan pertanyaan Anda.";
                return;
            }

            aiAnswerResultDiv.classList.add('hidden');
            aiAnswerLoadingDiv.classList.remove('hidden');
            aiAnswerContentDiv.innerHTML = '';

            const prompt = `Sebagai ahli trading kripto, jelaskan "${question}" dengan bahasa yang mudah dimengerti oleh pemula berusia 14 tahun, fokus pada konsep dasar kripto. Jangan gunakan jargon yang tidak perlu.`;

            const answer = await callGeminiAPI(prompt);
            aiAnswerContentDiv.innerHTML = answer;
            aiAnswerLoadingDiv.classList.add('hidden');
            aiAnswerResultDiv.classList.remove('hidden');
            aiAnswerResultDiv.className = "mt-4 p-4 bg-indigo-50 rounded-lg text-indigo-800";
        });

        // Simulate Scenario
        const simulateScenarioBtn = document.getElementById('simulate-scenario-btn');
        const scenarioInput = document.getElementById('scenario-input');
        const scenarioResultDiv = document.getElementById('scenario-result');
        const scenarioContentDiv = document.getElementById('scenario-content');
        const scenarioLoadingDiv = document.getElementById('scenario-loading');

        simulateScenarioBtn.addEventListener('click', async () => {
            const scenario = scenarioInput.value.trim();
            if (!scenario) {
                scenarioResultDiv.classList.remove('hidden');
                scenarioResultDiv.className = "mt-4 p-4 bg-red-50 rounded-lg text-red-800";
                scenarioContentDiv.innerHTML = "Mohon masukkan skenario yang ingin disimulasikan.";
                return;
            }

            scenarioResultDiv.classList.add('hidden');
            scenarioLoadingDiv.classList.remove('hidden');
            scenarioContentDiv.innerHTML = '';

            const coinName = "koin kripto yang sedang Anda analisis";
            const prompt = `Sebagai ahli trading kripto, jelaskan bagaimana seorang trader mungkin bereaksi dan apa yang harus diperhatikan jika "${scenario}" terjadi pada ${coinName}. Fokus pada analisis teknis dan manajemen risiko. Jelaskan dengan bahasa yang mudah dipahami pemula.`;

            const response = await callGeminiAPI(prompt);
            scenarioContentDiv.innerHTML = response;
            scenarioLoadingDiv.classList.add('hidden');
            scenarioResultDiv.classList.remove('hidden');
            scenarioResultDiv.className = "mt-4 p-4 bg-purple-50 rounded-lg text-purple-800";
        });

        // Generate News Summary
        const generateNewsSummaryBtn = document.getElementById('generate-news-summary-btn');
        const newsSummaryResultDiv = document.getElementById('news-summary-result');
        const newsSummaryContentDiv = document.getElementById('news-summary-content');
        const newsSummaryLoadingDiv = document.getElementById('news-summary-loading');

        generateNewsSummaryBtn.addEventListener('click', async () => {
            newsSummaryResultDiv.classList.add('hidden');
            newsSummaryLoadingDiv.classList.remove('hidden');
            newsSummaryContentDiv.innerHTML = '';

            const coinName = "koin kripto yang sedang Anda analisis";
            const prompt = `Sebagai analis pasar kripto, berikan ringkasan berita hipotetis singkat (1-2 paragraf) yang relevan dengan ${coinName} dan jelaskan bagaimana berita tersebut dapat mempengaruhi harganya secara umum. Fokus pada dampak fundamental dan sentimen pasar. Gunakan bahasa yang mudah dipahami pemula.`;

            const summary = await callGeminiAPI(prompt);
            newsSummaryContentDiv.innerHTML = summary;
            newsSummaryLoadingDiv.classList.add('hidden');
            newsSummaryResultDiv.classList.remove('hidden');
            newsSummaryResultDiv.className = "mt-4 p-4 bg-blue-50 rounded-lg text-blue-800";
        });

        // Explain Jargon
        const explainJargonBtn = document.getElementById('explain-jargon-btn');
        const jargonInput = document.getElementById('jargon-input');
        const jargonResultDiv = document.getElementById('jargon-result');
        const jargonContentDiv = document.getElementById('jargon-content');
        const jargonLoadingDiv = document.getElementById('jargon-loading');

        explainJargonBtn.addEventListener('click', async () => {
            const jargon = jargonInput.value.trim();
            if (!jargon) {
                jargonResultDiv.classList.remove('hidden');
                jargonResultDiv.className = "mt-4 p-4 bg-red-50 rounded-lg text-red-800";
                jargonContentDiv.innerHTML = "Mohon masukkan jargon yang ingin dijelaskan.";
                return;
            }

            jargonResultDiv.classList.add('hidden');
            jargonLoadingDiv.classList.remove('hidden');
            jargonContentDiv.innerHTML = '';

            const prompt = `Jelaskan istilah kripto "${jargon}" dengan bahasa yang sangat sederhana dan mudah dimengerti oleh pemula berusia 14 tahun. Berikan analogi singkat jika memungkinkan.`;

            const explanation = await callGeminiAPI(prompt);
            jargonContentDiv.innerHTML = explanation;
            jargonLoadingDiv.classList.add('hidden');
            jargonResultDiv.classList.remove('hidden');
            jargonResultDiv.className = "mt-4 p-4 bg-purple-50 rounded-lg text-purple-800";
        });

        // Predict Trend
        const predictTrendBtn = document.getElementById('predict-trend-btn');
        const trendPredictionResultDiv = document.getElementById('trend-prediction-result');
        const trendPredictionContentDiv = document.getElementById('trend-prediction-content');
        const trendPredictionLoadingDiv = document.getElementById('trend-prediction-loading');

        predictTrendBtn.addEventListener('click', async () => {
            trendPredictionResultDiv.classList.add('hidden');
            trendPredictionLoadingDiv.classList.remove('hidden');
            trendPredictionContentDiv.innerHTML = '';

            const coinName = "koin kripto yang sedang Anda analisis";
            const prompt = `Sebagai analis pasar kripto, berikan prediksi tren jangka pendek (misalnya, bullish, bearish, atau sideways) untuk ${coinName} dan berikan alasan hipotetis yang sangat sederhana. Ingat, ini hanya untuk tujuan edukasi dan bukan nasihat finansial.`;

            const prediction = await callGeminiAPI(prompt);
            trendPredictionContentDiv.innerHTML = prediction;
            trendPredictionLoadingDiv.classList.add('hidden');
            trendPredictionResultDiv.classList.remove('hidden');
            trendPredictionResultDiv.className = "mt-4 p-4 bg-orange-50 rounded-lg text-orange-800";
        });
    }

    function showPatternInsightModal(pattern, type) {
        const modal = document.getElementById('pattern-insight-modal');
        document.getElementById('modal-pattern-name').textContent = pattern.name;
        document.getElementById('modal-pattern-desc').textContent = pattern.desc;
        
        const illustrationContainer = document.getElementById('modal-pattern-illustration');
        illustrationContainer.innerHTML = '';
        if (type === 'candlestick' && pattern.illustration) {
            illustrationContainer.innerHTML = generateCandlestickIllustration(pattern.illustration);
        } else {
            illustrationContainer.innerHTML = '<p class="text-gray-500 text-sm">Ilustrasi pola grafik tidak tersedia di sini.</p>';
        }

        document.getElementById('pattern-insight-result').classList.add('hidden');
        document.getElementById('pattern-insight-loading').classList.add('hidden');
        document.getElementById('pattern-insight-content').innerHTML = '';

        modal.style.display = 'flex';
    }

    // --- SIMULATION LOGIC ---
    function setupSimulation() {
        const simCoinSelect = document.getElementById('sim-coin-select');
        const allowedCoins = ['BTC', 'ETH', 'SOL', 'BNB', 'ADA'];
        simCoinSelect.innerHTML = allowedCoins.map(key => 
            `<option value="${key}" ${key === state.simulation.selectedSimCoin ? 'selected' : ''}>${appData.coins[key].name} (${key})</option>`
        ).join('');
        simCoinSelect.addEventListener('change', (e) => {
            state.simulation.selectedSimCoin = e.target.value;
            document.getElementById('sim-current-coin-display').textContent = e.target.value;
            document.getElementById('sim-holding-coin-display').textContent = e.target.value;
            document.getElementById('buy-coin-display').textContent = e.target.value;
            document.getElementById('sell-coin-display').textContent = e.target.value;
            resetSimulation();
        });

        document.getElementById('sim-start-sim-btn').addEventListener('click', startOverallSimulation);
        document.getElementById('sim-reset-sim-btn').addEventListener('click', resetSimulation);
        document.getElementById('buy-btn').addEventListener('click', buyCoin);
        document.getElementById('sell-btn').addEventListener('click', sellCoin);

        // ApexCharts specific controls
        document.getElementById("sim-timeframe").addEventListener("change", () => {
            state.simulation.simTimeframeMilliseconds = parseInt(document.getElementById("sim-timeframe").value);
            // Re-initialize chart with new timeframe and restart simulation
            stopSimulationChart(); 
            initializeSimChart();
            startSimulationChart();
        });

        document.getElementById("sim-chart-pauseBtn").addEventListener("click", pauseSim);
        document.getElementById("sim-chart-resumeBtn").addEventListener("click", resumeSim);

        // New AI feature buttons
        document.getElementById('analyze-trade-btn').addEventListener('click', analyzeLastTrade);
        document.getElementById('suggest-strategy-btn').addEventListener('click', suggestStrategy);
        document.getElementById('evaluate-portfolio-btn').addEventListener('click', evaluatePortfolio);

        // Call updateSimulationUI only if elements are expected to be present, or add null checks within it.
        // For initial load, it's safer to call it after the view is rendered.
        // However, since it's called in init(), we need the null checks.
        updateSimulationUI();
        renderTransactionLog();
    }

    // Initialize ApexCharts for simulation
    function initializeSimChart() {
        if (typeof ApexCharts === 'undefined' || !ApexCharts) {
            console.error("ApexCharts library is not loaded or not properly initialized.");
            return;
        }

        const chartElement = document.getElementById('chart');
        const volumeChartElement = document.getElementById('volumeChart');
        if (!chartElement || !volumeChartElement) {
            console.error("Error: Chart elements not found for ApexCharts initialization.");
            // Do not call updateSimulationUI here if elements are null, as it will cause errors.
            return;
        }

        // Destroy existing charts if they exist
        if (state.simulation.simChartInstance) {
            state.simulation.simChartInstance.destroy();
            state.simulation.simChartInstance = null;
        }
        if (state.simulation.simVolumeChartInstance) {
            state.simulation.simVolumeChartInstance.destroy();
            state.simulation.simVolumeChartInstance = null;
        }

        const chartWidth = chartElement.clientWidth;
        const chartHeight = chartElement.clientHeight;

        if (chartWidth === 0 || chartHeight === 0) {
            console.warn("Chart element has zero dimensions. Deferring ApexCharts initialization. Current dimensions:", chartWidth, chartHeight);
            setTimeout(() => initializeSimChart(), 100);
            return;
        }

        console.log("Attempting to initialize sim chart with dimensions:", chartWidth, chartHeight);

        try {
            const initialData = generateInitialSimData(50); // Generate initial 50 candles
            state.simulation.candleData = initialData.candles;
            state.simulation.volumeData = initialData.volumes;
            state.simulation.simLastTime = initialData.lastTime; // Update last time after initial data generation

            const chartOptions = {
                series: [{
                    data: state.simulation.candleData
                }],
                chart: {
                    type: 'candlestick',
                    height: chartHeight,
                    width: '100%',
                    animations: {
                        enabled: false // Disable animations for real-time updates
                    },
                    toolbar: {
                        show: false
                    },
                    zoom: {
                        enabled: true
                    }
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        formatter: function(val) {
                            return new Date(val).toLocaleString();
                        },
                        style: {
                            colors: '#334155' // Darker text for light background
                        }
                    }
                },
                yaxis: {
                    tooltip: {
                        enabled: true
                    },
                    labels: {
                        style: {
                            colors: '#334155' // Darker text for light background
                        }
                    }
                },
                plotOptions: {
                    candlestick: {
                        colors: {
                            upward: '#22C55E',   // Green
                            downward: '#EF4444' // Red
                        }
                    }
                },
                grid: {
                    borderColor: '#e0e0e0',
                },
                tooltip: {
                    x: {
                        format: 'dd MMM HH:mm'
                    }
                }
            };

            const volumeChartOptions = {
                series: [{
                    name: 'Volume',
                    data: state.simulation.volumeData
                }],
                chart: {
                    type: 'bar',
                    height: 150,
                    width: '100%',
                    animations: {
                        enabled: false
                    },
                    toolbar: {
                        show: false
                    },
                    zoom: {
                        enabled: true
                    }
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        formatter: function(val) {
                            return new Date(val).toLocaleString();
                        },
                        style: {
                            colors: '#334155' // Darker text for light background
                        }
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            colors: '#334155' // Darker text for light background
                        }
                    }
                },
                colors: ['#3b82f6'], // Blue for volume bars
                grid: {
                    borderColor: '#e0e0e0',
                },
                tooltip: {
                    x: {
                        format: 'dd MMM HH:mm'
                    }
                }
            };

            state.simulation.simChartInstance = new ApexCharts(chartElement, chartOptions);
            state.simulation.simChartInstance.render();

            state.simulation.simVolumeChartInstance = new ApexCharts(volumeChartElement, volumeChartOptions);
            state.simulation.simVolumeChartInstance.render();

            // Set current price from the last candle
            if (state.simulation.candleData.length > 0) {
                state.simulation.currentPrice = state.simulation.candleData[state.simulation.candleData.length - 1].y[3]; // Close price
            }
            updateSimulationUI(); // Now it's safe to call this after charts are rendered

        } catch (error) {
            console.error("Error during ApexCharts initialization:", error);
            state.simulation.simChartInstance = null;
            state.simulation.simVolumeChartInstance = null;
        }
    }

    // Generate a new candle and volume data point for ApexCharts
    function getNextSimData(lastKnownPrice) {
        const volatilityFactor = 0.005; // Base volatility (0.5% up/down)
        const eventImpactFactor = state.simulation.newsImpact * 0.005; // News impact (e.g., 2 -> 1% impact)

        let open = lastKnownPrice;
        if (!open) {
            open = appData.coins[state.simulation.selectedSimCoin].initialPrice;
        }
        
        let close = open * (1 + (Math.random() - 0.5) * volatilityFactor * 2 + eventImpactFactor);
        
        if (state.simulation.selectedSimCoin === 'ADA') {
            if (close < 0.00001) close = 0.00001;
        } else {
            if (close < 0.01) close = 0.01;
        }

        let high = Math.max(open, close) * (1 + Math.random() * 0.002);
        let low = Math.min(open, close) * (1 - Math.random() * 0.002);

        const time = state.simulation.simLastTime + state.simulation.simTimeframeMilliseconds;

        state.simulation.simLastTime = time;
        state.simulation.currentPrice = close;

        const volume = Math.floor(Math.random() * 100 + 10 + Math.abs(state.simulation.newsImpact) * 50); // Volume also impacted by news

        return {
            candle: {
                x: new Date(time),
                y: [open, high, low, close].map(val => parseFloat(val.toFixed(6)))
            },
            volume: {
                x: new Date(time),
                y: volume
            }
        };
    }

    // Generate initial data for ApexCharts
    function generateInitialSimData(numCandles = 50) {
        const candles = [];
        const volumes = [];
        let currentTime = Date.now() - (numCandles * state.simulation.simTimeframeMilliseconds);
        let currentPriceForInit = appData.coins[state.simulation.selectedSimCoin].initialPrice;

        for (let i = 0; i < numCandles; i++) {
            const open = currentPriceForInit;
            const close = open * (1 + (Math.random() - 0.5) * 0.01);
            const high = Math.max(open, close) * (1 + Math.random() * 0.002);
            const low = Math.min(open, close) * (1 - Math.random() * 0.002);
            const volume = Math.floor(Math.random() * 100 + 10);

            candles.push({
                x: new Date(currentTime),
                y: [open, high, low, close].map(val => parseFloat(val.toFixed(6)))
            });
            volumes.push({
                x: new Date(currentTime),
                y: volume
            });
            currentPriceForInit = close;
            currentTime += state.simulation.simTimeframeMilliseconds;
        }
        return { candles, volumes, lastTime: currentTime };
    }

    // Start the ApexCharts candlestick and volume simulation
    function startSimulationChart() {
        if (state.simulation.priceInterval) return;

        if (!state.simulation.simChartInstance || !state.simulation.simVolumeChartInstance) {
            console.warn("Charts not initialized. Attempting to initialize...");
            initializeSimChart();
            if (!state.simulation.simChartInstance || !state.simulation.simVolumeChartInstance) {
                console.error("Failed to initialize charts after retry. Cannot start simulation.");
                return;
            }
        }

        state.simulation.priceInterval = setInterval(() => {
            const lastCandle = state.simulation.candleData[state.simulation.candleData.length - 1];
            const newSimData = getNextSimData(lastCandle ? lastCandle.y[3] : null);
            
            state.simulation.candleData.push(newSimData.candle);
            state.simulation.volumeData.push(newSimData.volume);
            
            const maxCandles = 60; // Keep roughly 60 candles visible
            if (state.simulation.candleData.length > maxCandles) {
                state.simulation.candleData.shift();
                state.simulation.volumeData.shift();
            }

            if (state.simulation.simChartInstance && state.simulation.simVolumeChartInstance) {
                state.simulation.simChartInstance.updateSeries([{ data: state.simulation.candleData }]);
                state.simulation.simVolumeChartInstance.updateSeries([{ data: state.simulation.volumeData }]);
            } else {
                console.error("Chart instances are null. Cannot update charts.");
                stopSimulationChart();
                return;
            }
            updateSimulationUI();
        }, 1000); // Update every 1 second

        startNewsGeneration();
    }

    // Stop the ApexCharts candlestick and volume simulation
    function stopSimulationChart() {
        if (state.simulation.priceInterval) {
            clearInterval(state.simulation.priceInterval);
            state.simulation.priceInterval = null;
        }
        stopNewsGeneration();
    }

    function pauseSim() {
        stopSimulationChart(); // Uses the same logic as stop
        console.log("Simulation paused.");
    }

    function resumeSim() {
        startSimulationChart(); // Uses the same logic as start
        console.log("Simulation resumed.");
    }

    // Overall simulation start (for balance, holdings, etc.)
    function startOverallSimulation() {
        if (state.simulation.active) return;

        state.simulation.active = true;
        state.simulation.balance = 10000;
        state.simulation.coinHoldings = {};
        state.simulation.coinHoldings[state.simulation.selectedSimCoin] = 0;
        state.simulation.initialBuyPrice = 0;
        state.simulation.newsImpact = 0; // Reset news impact
        state.simulation.transactions = [];

        document.getElementById('sim-start-sim-btn').classList.add('hidden');
        document.getElementById('sim-reset-sim-btn').classList.remove('hidden');
        document.getElementById('sim-coin-select').disabled = true;
        document.getElementById('sim-pnl-info').classList.add('hidden');
        document.getElementById('newsBox').classList.remove('breaking');
        document.getElementById('newsBox').textContent = "Tidak ada berita saat ini...";

        initializeSimChart(); // Re-initialize charts to clear old data
        startSimulationChart();
        updateSimulationUI();
        renderTransactionLog();
    }

    function resetSimulation() {
        stopSimulationChart();
        state.simulation.active = false;
        state.simulation.balance = 10000;
        state.simulation.coinHoldings = {};
        state.simulation.coinHoldings[state.simulation.selectedSimCoin] = 0;
        state.simulation.currentPrice = 0;
        state.simulation.initialBuyPrice = 0;
        state.simulation.newsImpact = 0;
        state.simulation.transactions = [];

        if (state.simulation.simChartInstance) {
            state.simulation.simChartInstance.destroy();
            state.simulation.simChartInstance = null;
        }
        if (state.simulation.simVolumeChartInstance) {
            state.simulation.simVolumeChartInstance.destroy();
            state.simulation.simVolumeChartInstance = null;
        }
        state.simulation.candleData = [];
        state.simulation.volumeData = [];

        document.getElementById('sim-start-sim-btn').classList.remove('hidden');
        document.getElementById('sim-reset-sim-btn').classList.add('hidden');
        document.getElementById('sim-coin-select').disabled = false;
        document.getElementById('buy-amount').value = '';
        document.getElementById('sell-amount').value = '';
        document.getElementById('sim-pnl-info').classList.add('hidden');
        document.getElementById('newsBox').classList.remove('breaking');
        document.getElementById('newsBox').textContent = "Tidak ada berita saat ini...";

        updateSimulationUI();
        renderTransactionLog();
    }

    function updateNews() {
        const newsChance = Math.random();
        if (newsChance < 0.2) { // 20% chance to trigger an event
            state.simulation.newsIndex = (state.simulation.newsIndex + 1) % state.simulation.newsList.length;
            const news = state.simulation.newsList[state.simulation.newsIndex];
            const newsBox = document.getElementById('newsBox');
            if (newsBox) { // Add null check
                newsBox.innerText = `üì¢ BREAKING NEWS: ${news.text}`;
                newsBox.classList.add("breaking");
            }
            state.simulation.newsImpact = news.impact;
            clearTimeout(state.simulation.breakingTimeout);
            state.simulation.breakingTimeout = setTimeout(() => {
                if (newsBox) { // Add null check
                    newsBox.innerText = "Tidak ada berita saat ini...";
                    newsBox.classList.remove("breaking");
                }
                state.simulation.newsImpact = 0;
            }, 10000); // News stays for 10 seconds
        }
    }

    function startNewsGeneration() {
        if (state.simulation.newsInterval) return;
        const minInterval = 30000; // 30 seconds
        const maxInterval = 60000; // 60 seconds
        const randomInterval = Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
        
        state.simulation.newsInterval = setInterval(updateNews, randomInterval);
        console.log(`News generation started with interval: ${randomInterval / 1000} seconds`);
    }

    function stopNewsGeneration() {
        if (state.simulation.newsInterval) {
            clearInterval(state.simulation.newsInterval);
            state.simulation.newsInterval = null;
            console.log("News generation stopped.");
        }
        if (state.simulation.breakingTimeout) {
            clearTimeout(state.simulation.breakingTimeout);
            state.simulation.breakingTimeout = null;
        }
        const newsBox = document.getElementById('newsBox');
        if (newsBox) { // Add null check
            newsBox.classList.remove('breaking');
            newsBox.textContent = "Tidak ada berita saat ini...";
        }
        state.simulation.newsImpact = 0;
    }

    function updateSimulationUI() {
        // Add null checks for all elements before accessing their properties
        const simBalance = document.getElementById('sim-balance');
        if (simBalance) {
            simBalance.textContent = state.simulation.balance.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        const simCurrentPrice = document.getElementById('sim-current-price');
        if (simCurrentPrice) {
            simCurrentPrice.textContent = state.simulation.currentPrice.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        const currentCoinHolding = state.simulation.coinHoldings[state.simulation.selectedSimCoin] || 0;
        const simCoinHolding = document.getElementById('sim-coin-holding');
        if (simCoinHolding) {
            simCoinHolding.textContent = currentCoinHolding.toFixed(4);
        }

        // Update Price, Change, Direction
        const priceElement = document.getElementById('price');
        const changeElement = document.getElementById('change');
        const directionElement = document.getElementById('direction');

        if (priceElement) { // Add null check
            priceElement.textContent = `Harga: $${state.simulation.currentPrice.toFixed(2)}`;
        }

        if (changeElement && directionElement) { // Add null checks
            if (state.simulation.candleData.length > 1) {
                const prevClose = state.simulation.candleData[state.simulation.candleData.length - 2].y[3];
                const currentClose = state.simulation.currentPrice;
                const percentageChange = ((currentClose - prevClose) / prevClose) * 100;
                changeElement.textContent = `Change: ${percentageChange.toFixed(2)}%`;
                if (percentageChange > 0) {
                    changeElement.style.color = '#22C55E'; // Green
                    directionElement.textContent = '‚ñ≤';
                    directionElement.style.color = '#22C55E';
                } else if (percentageChange < 0) {
                    changeElement.style.color = '#EF4444'; // Red
                    directionElement.textContent = '‚ñº';
                    directionElement.style.color = '#EF4444';
                } else {
                    changeElement.style.color = ''; // Reset
                    directionElement.textContent = '‚¨ç';
                    directionElement.style.color = '';
                }
            } else {
                changeElement.textContent = 'Change: 0%';
                changeElement.style.color = '';
                directionElement.textContent = '‚¨ç';
                directionElement.style.color = '';
            }
        }

        // Calculate and display PnL
        const totalValue = state.simulation.balance + currentCoinHolding * state.simulation.currentPrice;
        const totalValueElement = document.getElementById("totalValue");
        if (totalValueElement) { // Add null check
            totalValueElement.innerText = `üìà Total Value: $${totalValue.toFixed(2)}`;
        }

        const simPnl = document.getElementById('sim-pnl');
        const simPnlInfo = document.getElementById('sim-pnl-info');
        if (simPnl && simPnlInfo) { // Add null checks
            if (currentCoinHolding > 0 && state.simulation.initialBuyPrice > 0) {
                const unrealizedPnL = (state.simulation.currentPrice - state.simulation.initialBuyPrice) * currentCoinHolding;
                simPnl.textContent = unrealizedPnL.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
                simPnl.className = `text-xl font-bold ${unrealizedPnL >= 0 ? 'text-green-600' : 'text-red-600'}`;
                simPnlInfo.classList.remove('hidden');
            } else {
                simPnlInfo.classList.add('hidden');
            }
        }
    }

    function buyCoin() {
        const amountUSDT = parseFloat(document.getElementById('buy-amount').value);
        if (isNaN(amountUSDT) || amountUSDT <= 0) {
            showAlert("Masukkan jumlah USDT yang valid untuk dibeli.");
            return;
        }
        if (amountUSDT > state.simulation.balance) {
            showAlert("Saldo USDT tidak cukup.");
            return;
        }
        if (state.simulation.currentPrice <= 0) {
            showAlert("Harga koin belum tersedia atau tidak valid.");
            return;
        }

        const coinAmount = amountUSDT / state.simulation.currentPrice;
        state.simulation.balance -= amountUSDT;
        state.simulation.coinHoldings[state.simulation.selectedSimCoin] = (state.simulation.coinHoldings[state.simulation.selectedSimCoin] || 0) + coinAmount;
        
        const currentHoldingBeforeBuy = state.simulation.coinHoldings[state.simulation.selectedSimCoin] - coinAmount;
        if (currentHoldingBeforeBuy > 0) {
            const totalCostBefore = state.simulation.initialBuyPrice * currentHoldingBeforeBuy;
            const newTotalCost = totalCostBefore + amountUSDT;
            state.simulation.initialBuyPrice = newTotalCost / state.simulation.coinHoldings[state.simulation.selectedSimCoin];
        } else {
            state.simulation.initialBuyPrice = state.simulation.currentPrice;
        }

        state.simulation.transactions.push({
            time: new Date().toLocaleString(),
            coin: state.simulation.selectedSimCoin,
            action: 'Beli',
            amount: coinAmount.toFixed(4),
            price: state.simulation.currentPrice.toFixed(2),
            total: amountUSDT.toFixed(2),
            pnl_percent: '-',
            pnl_usd: '-'
        });

        document.getElementById('buy-amount').value = '';
        updateSimulationUI();
        renderTransactionLog();
    }

    function sellCoin() {
        const amountCoin = parseFloat(document.getElementById('sell-amount').value);
        const currentCoinHolding = state.simulation.coinHoldings[state.simulation.selectedSimCoin] || 0;

        if (isNaN(amountCoin) || amountCoin <= 0) {
            showAlert("Masukkan jumlah koin yang valid untuk dijual.");
            return;
        }
        if (amountCoin > currentCoinHolding) {
            showAlert("Jumlah koin tidak cukup untuk dijual.");
            return;
        }
        if (state.simulation.currentPrice <= 0) {
            showAlert("Harga koin belum tersedia atau tidak valid.");
            return;
        }

        const usdtReceived = amountCoin * state.simulation.currentPrice;
        state.simulation.balance += usdtReceived;
        state.simulation.coinHoldings[state.simulation.selectedSimCoin] -= amountCoin;
        
        let pnlPercent = 0;
        let pnlUsd = 0;

        if (state.simulation.initialBuyPrice > 0) {
            pnlUsd = (state.simulation.currentPrice - state.simulation.initialBuyPrice) * amountCoin;
            pnlPercent = (pnlUsd / (state.simulation.initialBuyPrice * amountCoin)) * 100;
        }

        if (state.simulation.coinHoldings[state.simulation.selectedSimCoin] < 0.0001) {
            state.simulation.coinHoldings[state.simulation.selectedSimCoin] = 0;
            state.simulation.initialBuyPrice = 0;
        }

        state.simulation.transactions.push({
            time: new Date().toLocaleString(),
            coin: state.simulation.selectedSimCoin,
            action: 'Jual',
            amount: amountCoin.toFixed(4),
            price: state.simulation.currentPrice.toFixed(2),
            total: usdtReceived.toFixed(2),
            pnl_percent: pnlPercent.toFixed(2) + '%',
            pnl_usd: pnlUsd.toFixed(2)
        });

        document.getElementById('sell-amount').value = '';
        updateSimulationUI();
        renderTransactionLog();
    }

    function renderTransactionLog() {
        const logBody = document.getElementById('transaction-log-body');
        if (!logBody) return; // Add null check for logBody

        logBody.innerHTML = '';

        state.simulation.transactions.slice().reverse().forEach(tx => {
            const row = logBody.insertRow();
            row.className = 'bg-white border-b';
            row.insertCell().textContent = tx.time;
            row.insertCell().textContent = tx.coin;
            row.insertCell().textContent = tx.action;
            row.insertCell().textContent = tx.amount;
            row.insertCell().textContent = `$${tx.price}`;
            row.insertCell().textContent = `$${tx.total}`;
            
            const pnlPercentCell = row.insertCell();
            pnlPercentCell.textContent = tx.pnl_percent;
            if (tx.pnl_percent !== '-') {
                pnlPercentCell.classList.add(parseFloat(tx.pnl_percent) >= 0 ? 'text-green-600' : 'text-red-600');
            }

            const pnlUsdCell = row.insertCell();
            pnlUsdCell.textContent = `$${tx.pnl_usd}`;
            if (tx.pnl_usd !== '-') {
                pnlUsdCell.classList.add(parseFloat(tx.pnl_usd) >= 0 ? 'text-green-600' : 'text-red-600');
            }
        });
    }

    // --- NEW GEMINI API FEATURES FOR SIMULATION ---

    async function analyzeLastTrade() {
        const tradeAnalysisResultDiv = document.getElementById('trade-analysis-result');
        const tradeAnalysisContentDiv = document.getElementById('trade-analysis-content');
        const tradeAnalysisLoadingDiv = document.getElementById('trade-analysis-loading');

        tradeAnalysisResultDiv.classList.add('hidden');
        tradeAnalysisLoadingDiv.classList.remove('hidden');
        tradeAnalysisContentDiv.innerHTML = '';

        if (state.simulation.transactions.length === 0) {
            tradeAnalysisResultDiv.classList.remove('hidden');
            tradeAnalysisResultDiv.className = "mt-4 p-4 bg-yellow-50 rounded-lg text-yellow-800";
            tradeAnalysisContentDiv.innerHTML = "Belum ada transaksi untuk dianalisis.";
            tradeAnalysisLoadingDiv.classList.add('hidden');
            return;
        }

        const lastTrade = state.simulation.transactions[state.simulation.transactions.length - 1];
        const currentPrice = state.simulation.currentPrice;
        const coinName = appData.coins[state.simulation.selectedSimCoin].name;

        let prompt = `Sebagai analis trading kripto, berikan analisis singkat (1-2 paragraf) tentang transaksi terakhir ini:\n`;
        prompt += `- Aksi: ${lastTrade.action}\n`;
        prompt += `- Koin: ${coinName} (${lastTrade.coin})\n`;
        prompt += `- Jumlah: ${lastTrade.amount} ${lastTrade.coin}\n`;
        prompt += `- Harga Transaksi: $${lastTrade.price}\n`;
        prompt += `- Harga Saat Ini: $${currentPrice.toFixed(2)}\n`;
        if (lastTrade.pnl_usd !== '-') {
            prompt += `- Keuntungan/Kerugian: $${lastTrade.pnl_usd} (${lastTrade.pnl_percent})\n`;
        }
        prompt += `Apakah ini perdagangan yang baik atau buruk berdasarkan harga saat ini? Berikan alasan sederhana.`;

        const analysis = await callGeminiAPI(prompt);
        tradeAnalysisContentDiv.innerHTML = analysis;
        tradeAnalysisLoadingDiv.classList.add('hidden');
        tradeAnalysisResultDiv.classList.remove('hidden');
        tradeAnalysisResultDiv.className = "mt-4 p-4 bg-indigo-50 rounded-lg text-indigo-800";
    }

    async function suggestStrategy() {
        const strategySuggestionResultDiv = document.getElementById('strategy-suggestion-result');
        const strategySuggestionContentDiv = document.getElementById('strategy-suggestion-content');
        const strategySuggestionLoadingDiv = document.getElementById('strategy-suggestion-loading');

        strategySuggestionResultDiv.classList.add('hidden');
        strategySuggestionLoadingDiv.classList.remove('hidden');
        strategySuggestionContentDiv.innerHTML = '';

        if (state.simulation.candleData.length < 10) {
            strategySuggestionResultDiv.classList.remove('hidden');
            strategySuggestionResultDiv.className = "mt-4 p-4 bg-yellow-50 rounded-lg text-yellow-800";
            strategySuggestionContentDiv.innerHTML = "Dibutuhkan lebih banyak data grafik untuk menyarankan strategi. Biarkan simulasi berjalan sebentar.";
            strategySuggestionLoadingDiv.classList.add('hidden');
            return;
        }

        // Get recent price data to infer trend/volatility
        const recentCloses = state.simulation.candleData.slice(-10).map(d => d.y[3]); // Last 10 close prices
        const maxPrice = Math.max(...recentCloses);
        const minPrice = Math.min(...recentCloses);
        const priceRange = maxPrice - minPrice;
        const averagePrice = recentCloses.reduce((a, b) => a + b, 0) / recentCloses.length;

        let trend = "sideways";
        if (recentCloses[recentCloses.length - 1] > recentCloses[0] * 1.02) { // 2% up
            trend = "uptrend";
        } else if (recentCloses[recentCloses.length - 1] < recentCloses[0] * 0.98) { // 2% down
            trend = "downtrend";
        }

        let volatility = "rendah";
        if (priceRange / averagePrice > 0.03) { // 3% range
            volatility = "tinggi";
        }

        const prompt = `Berdasarkan kondisi pasar simulasi saat ini di mana harga ${state.simulation.selectedSimCoin} menunjukkan tren ${trend} dan volatilitas ${volatility}, berikan saran strategi trading umum (misalnya, strategi mengikuti tren, strategi range-bound, atau strategi breakout) yang cocok untuk pemula. Jelaskan alasannya secara singkat.`;

        const suggestion = await callGeminiAPI(prompt);
        strategySuggestionContentDiv.innerHTML = suggestion;
        strategySuggestionLoadingDiv.classList.add('hidden');
        strategySuggestionResultDiv.classList.remove('hidden');
        strategySuggestionResultDiv.className = "mt-4 p-4 bg-green-50 rounded-lg text-green-800";
    }

    async function evaluatePortfolio() {
        const portfolioEvaluationResultDiv = document.getElementById('portfolio-evaluation-result');
        const portfolioEvaluationContentDiv = document.getElementById('portfolio-evaluation-content');
        const portfolioEvaluationLoadingDiv = document.getElementById('portfolio-evaluation-loading');

        portfolioEvaluationResultDiv.classList.add('hidden');
        portfolioEvaluationLoadingDiv.classList.remove('hidden');
        portfolioEvaluationContentDiv.innerHTML = '';

        const currentCoinHolding = state.simulation.coinHoldings[state.simulation.selectedSimCoin] || 0;
        const totalValue = state.simulation.balance + currentCoinHolding * state.simulation.currentPrice;
        const initialBalance = 10000; // Assuming initial balance is always 10000

        let performanceStatus = "netral";
        let pnlOverall = totalValue - initialBalance;
        if (pnlOverall > 0) {
            performanceStatus = "menguntungkan";
        } else if (pnlOverall < 0) {
            performanceStatus = "merugi";
        }

        let holdingInfo = "";
        if (currentCoinHolding > 0) {
            holdingInfo = `Anda saat ini memegang ${currentCoinHolding.toFixed(4)} ${state.simulation.selectedSimCoin} dengan harga beli rata-rata $${state.simulation.initialBuyPrice.toFixed(2)}. Harga saat ini adalah $${state.simulation.currentPrice.toFixed(2)}.`;
        } else {
            holdingInfo = "Anda tidak memegang koin apapun saat ini.";
        }

        const prompt = `Sebagai penasihat trading AI, berikan evaluasi singkat (1-2 paragraf) tentang portofolio simulasi ini:\n`;
        prompt += `- Saldo USDT: $${state.simulation.balance.toFixed(2)}\n`;
        prompt += `- Total Nilai Portofolio: $${totalValue.toFixed(2)}\n`;
        prompt += `- Kinerja Keseluruhan: ${performanceStatus} (P/L: $${pnlOverall.toFixed(2)})\n`;
        prompt += `- Informasi Kepemilikan: ${holdingInfo}\n\n`;
        prompt += `Berikan saran singkat untuk meningkatkan kinerja atau mengelola risiko.`;

        const evaluation = await callGeminiAPI(prompt);
        portfolioEvaluationContentDiv.innerHTML = evaluation;
        portfolioEvaluationLoadingDiv.classList.add('hidden');
        portfolioEvaluationResultDiv.classList.remove('hidden');
        portfolioEvaluationResultDiv.className = "mt-4 p-4 bg-purple-50 rounded-lg text-purple-800";
    }

    init();
};
</script>
</body>
</html>
